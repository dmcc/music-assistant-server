# Release Workflow Guide

This document explains how to use the new release workflow for Music Assistant.

## Overview

The release workflow has been completely reworked to **create releases** rather than being triggered by them. This gives you more control over the release process and ensures consistency across different release channels.

## How to Create a Release

1. Go to the **Actions** tab in GitHub
2. Select the **"Create Release"** workflow
3. Click **"Run workflow"**
4. Fill in the required inputs:
   - **Version number**: Enter the version in the appropriate format (see below)
   - **Release channel**: Select from `stable`, `beta`, or `nightly`
5. Click **"Run workflow"** to start the release process

## Version Format Requirements

The workflow validates version numbers based on the selected channel:

### Stable Channel
- **Format**: `X.Y.Z` (e.g., `2.1.0`, `2.1.1`)
- **Examples**:
  - ‚úÖ `2.1.0`
  - ‚úÖ `1.5.3`
  - ‚ùå `2.1.0.b1` (beta suffix not allowed for stable)

### Beta Channel
- **Format**: `X.Y.Z.bN` (e.g., `2.1.0.b1`, `2.1.0.b2`)
- **Examples**:
  - ‚úÖ `2.1.0.b1`
  - ‚úÖ `2.2.0.b3`
  - ‚ùå `2.1.0` (must have beta suffix)

### Nightly Channel
- **Format**: `X.Y.Z.devN` (e.g., `2.1.0.dev1`, `2.1.0.dev20251023`)
- **Examples**:
  - ‚úÖ `2.1.0.dev1`
  - ‚úÖ `2.1.0.dev20251023`
  - ‚ùå `2.1.0` (must have dev suffix)

## What the Workflow Does

### 1. Validation & Build (`validate-and-build` job)
- ‚úÖ Validates the version number format matches the selected channel
- ‚úÖ Updates the version in `pyproject.toml`
- ‚úÖ Builds the Python package (wheel and source distribution)
- ‚úÖ Uploads artifacts for use in subsequent jobs

### 2. Create Release (`create-release` job)
- ‚úÖ Checks out the correct branch (stable for stable releases, dev for beta/nightly)
- ‚úÖ Determines the previous release tag for the same channel
- ‚úÖ Uses Release Drafter to generate release notes from PRs/commits on that branch
- ‚úÖ **Extracts and appends frontend changes** from music-assistant-frontend update PRs
- ‚úÖ **Merges and deduplicates contributors** from both server and frontend PRs
- ‚úÖ Creates a GitHub release (marked as prerelease for beta/nightly)
- ‚úÖ Attaches the built Python packages to the release

#### Branch Strategy
- **Stable releases** (`X.Y.Z`): Built from the `stable` branch
- **Beta releases** (`X.Y.Z.bN`): Built from the `dev` branch
- **Nightly releases** (`X.Y.Z.devN`): Built from the `dev` branch

This ensures stable releases only include changes that have been merged to stable, while beta and nightly releases include the latest development changes.

#### Frontend Changes Integration
The workflow automatically finds all "‚¨ÜÔ∏è Update music-assistant-frontend to X.X.X" PRs that were merged since the last release and extracts their release notes. These are appended to the server release notes under a "üé® Frontend Changes" section as a unified list of all frontend changes across all versions. This ensures users can see both server and frontend changes in one place.

#### Contributor Merging
The workflow also extracts all `@username` mentions from both the server release notes (generated by Release Drafter) and the frontend PR descriptions, then merges and deduplicates them. The final "Thanks to our contributors" section includes everyone who contributed to both the server and frontend in this release cycle.

**Example of final release notes structure:**
```markdown
## ‚ö† Breaking Changes
- Server breaking change (by @serverdev in #123)

## üöÄ Features and enhancements
- Server feature 1 (by @contributor1 in #124)
- Server feature 2 (by @contributor2 in #125)

## üêõ Bugfixes
- Server bugfix (by @contributor1 in #126)

## üé® Frontend Changes
‚Ä¢ Add the provider type on items on search (by @frontenddev in #1174)
‚Ä¢ Fix player menu position (by @contributor3 in #1175)
‚Ä¢ Update translations (by @translator in #1170)
‚Ä¢ Fix dark mode styling issue (by @frontenddev in #1171)

## :bow: Thanks to our contributors

Special thanks to the following contributors who helped with this release:

@contributor1, @contributor2, @contributor3, @frontenddev, @serverdev, @translator
```

### 3. PyPI Publish (`pypi-publish` job)
- ‚úÖ **Only runs for stable releases**
- ‚úÖ Publishes the package to PyPI using the configured token

### 4. Docker Image Build (`build-and-push-container-image` job)
- ‚úÖ Builds multi-platform Docker images (amd64 + arm64)
- ‚úÖ Uses the correct base image version for the channel
- ‚úÖ Tags images appropriately based on the channel:

#### Stable Release Tags
- `ghcr.io/music-assistant/server:X.Y.Z`
- `ghcr.io/music-assistant/server:X.Y`
- `ghcr.io/music-assistant/server:X`
- `ghcr.io/music-assistant/server:stable`
- `ghcr.io/music-assistant/server:latest`

#### Beta Release Tags
- `ghcr.io/music-assistant/server:X.Y.Z.bN`
- `ghcr.io/music-assistant/server:beta`

#### Nightly Release Tags
- `ghcr.io/music-assistant/server:X.Y.Z.devN`
- `ghcr.io/music-assistant/server:nightly`

### 5. Update Add-on Repository (`update-addon-repository` job)
- ‚úÖ Determines the correct add-on folder based on channel:
  - **Stable**: `music_assistant`
  - **Beta**: `music_assistant_beta`
  - **Nightly**: `music_assistant_nightly`
- ‚úÖ Updates `config.yaml` with the new version number
- ‚úÖ Updates `CHANGELOG.md` with the full release notes
- ‚úÖ Keeps only the last 2 versions in the changelog (removes older entries)
- ‚úÖ Commits and pushes changes directly to the `music-assistant/home-assistant-addon` repository

This ensures the Home Assistant add-on is automatically updated with each release, making it immediately available to users!

## Base Image Versions

The workflow uses different base image versions per channel (configured in workflow env vars):

- **Stable**: `1.3.1`
- **Beta**: `1.3.2`
- **Nightly**: `1.3.2`

These can be updated in the workflow file's `env` section.

## Release Notes

Release notes are automatically generated by our custom release notes generator based on:
- Merged pull requests since the last release of the same channel
- PR labels (breaking-change, feature, bugfix, etc.)
- Contributors list (merged from server and frontend PRs)
- Frontend changes extracted from frontend update PRs

The configuration is in `.github/release-notes-config.yml`.

See `.github/actions/generate-release-notes/README.md` for more details on how the generator works.

## Examples

### Creating a Stable Release
```
Version: 2.1.0
Channel: stable
```
This will:
- Create release `2.1.0` (not a prerelease)
- Publish to PyPI
- Tag Docker images with `2.1.0`, `2.1`, `2`, `stable`, and `latest`

### Creating a Beta Release
```
Version: 2.2.0.b1
Channel: beta
```
This will:
- Create release `2.2.0.b1` (marked as prerelease)
- Skip PyPI publish
- Tag Docker images with `2.2.0.b1` and `beta`

### Creating a Nightly Release
```
Version: 2.2.0.dev20251023
Channel: nightly
```
This will:
- Create release `2.2.0.dev20251023` (marked as prerelease)
- Skip PyPI publish
- Tag Docker images with `2.2.0.dev20251023` and `nightly`

## Troubleshooting

### Workflow Fails During Validation
- Check that your version number matches the format for the selected channel
- Ensure the version doesn't already exist as a tag

### PyPI Publish Fails
- Verify the `PYPI_TOKEN` secret is configured correctly
- Check that the version doesn't already exist on PyPI

### Docker Build Fails
- Check that the base image version exists
- Verify the Dockerfile is compatible with the version being built

## Migration Notes

This workflow replaces the previous `release.yml` which was triggered by creating a release in GitHub. Key differences:

- **Before**: Create a release manually ‚Üí workflow publishes it
- **Now**: Trigger workflow ‚Üí it creates and publishes the release

The new approach provides better automation, validation, and consistency across channels.
